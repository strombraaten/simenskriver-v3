# Cursor Rules for Wayward Digital Garden

## What We’re Building (Intent)

This repository is based on **Quartz 4** and uses a **barebones template** of a theme called **Wayward**, made by the GitHub user **Afroviking**. It is also part of a broader effort: rebuilding an existing Quartz blog into a new, improved version with a slightly different architecture.

Key implications:
- There is **existing content and many historical links**. Preserve link integrity where possible and be explicit about migrations when not.
- This is a **fork of Quartz** (and also contains project-specific customizations). Prefer upstream Quartz patterns when practical, but don’t fight the architecture.
- Optimize for **simple, maintainable output**: prefer HTML and CSS over JavaScript when it achieves the same user-visible result.
- The long-term direction is **sustainable, low-footprint web**. When making choices that increase footprint (JS, heavy dependencies, client runtime, large assets), you must surface the **cost** (performance, bundle size, runtime work, complexity).
- Future-facing goal: enable **per-page carbon/footprint measurement**. You don’t need to implement it unless asked, but today’s choices should keep that path open (small, measurable, predictable output).

## Decision Principles (How to Choose)

When you have multiple implementation options, default to:
- **Quartz-aligned**: fits Quartz’ plugin/component pipeline and configuration model.
- **Minimal client-side JS**: prefer static rendering, CSS, progressive enhancement, and build-time transforms.
- **Low footprint**: fewer dependencies, smaller output, less runtime work.
- **Maintainable**: clear code, small components/plugins, predictable data flow.

If a proposed change likely increases footprint or performance cost, call it out explicitly (e.g., “this adds a client-side script to every page”, “this increases image payload”, “this adds N dependencies”, “this may slow down build time”).

## Project Overview

This is a Quartz-based digital garden called "Wayward" that organizes content into four distinct types:
- **Tanker** - Quick, fleeting thoughts and observations. Stream-like, chronological. Title is optional (auto-generated from first sentence if omitted)
- **Oppslagsverk** - Reference material, building blocks, summaries. Personal library of notes worth keeping
- **Utkast** - Ideas in progress, exploratory thinking. May or may not evolve into something more
- **Notater** - Complete, coherent long-form pieces. Intended to be finished (have a `stage` field: forming or done)

Each piece has a `why` value (keep, remember, think, work-out, share) that captures its purpose.

### Type & Why Matrix
Not all `why` values make sense for every `type`:
- **tanke**: `keep` ✔✔ | `remember` ✔✔ | `think` ✔ | `share` ✔
- **oppslagsverk**: `keep` ✔✔✔ | `remember` ✔✔ | `think` ✔✔ | `work-out` ✔✔ | `share` ✔
- **utkast**: `think` ✔✔✔ | `work-out` ✔✔✔ | `share` ✔
- **notat**: `share` ✔✔✔ | `work-out` ✔✔ | `think` ✔

## Architecture

### Content Structure
- `content/` - All markdown content organized by type
  - `Tanker/` - Quick, fleeting thoughts (stream-like, chronological)
  - `Oppslagsverk/` - Reference material and building blocks
  - `Utkast/` - Ideas in progress, exploratory thinking
  - `Notater/` - Complete, coherent long-form pieces
  - `index.md` - Homepage

### Quartz Core (`quartz/`)
- `components/` - Preact components for UI elements
  - Custom components: `CategoryList`, `WhyField`, `HeroImage`, `Pinned`, `RecentNotes`
  - Layout-specific rendering based on page type (index, content, list pages)
- `plugins/` - Transform, filter, and emit content
  - `transformers/` - Process markdown during build
    - `minimalCallout.ts` - Custom callout syntax `> [minimal-tip]`
    - `imageGallery.ts` - Auto-wraps 2+ consecutive images in galleries
    - `clickableImages.ts` - Adds lightbox functionality to images
  - `emitters/` - Generate output files
    - `imageOptimizer.ts` - Optimizes images during build
  - `filters/` - Filter content (e.g., `RemoveDrafts`)
- `styles/` - SCSS stylesheets (warm color theme with separate light/dark modes)
- `util/` - Utility functions (path resolution, language helpers, etc.)

### Configuration Files
- `quartz.config.ts` - Main Quartz configuration (plugins, theme, colors)
- `quartz.layout.ts` - Page layouts (index, content pages, list pages)
  - `sharedPageComponents` - Components on every page (head, footer)
  - `defaultContentPageLayout` - Individual post pages
  - `indexPageLayout` - Homepage with Tanker, Oppslagsverk, Utkast, Notater sections
  - `defaultListPageLayout` - Tag/folder listing pages
- `tsconfig.json` - TypeScript configuration (uses Preact for JSX)
- `package.json` - Dependencies and scripts

## Key Patterns

### Component Composition
- Components are registered in `quartz/components/index.ts`
- Use `ConditionalRender` wrapper to show/hide components based on page context
- Components receive `QuartzComponentProps` with `fileData`, `allFiles`, `cfg`, etc.

### Plugin Pipeline
1. **Transformers** - Process markdown (run in order: FrontMatter → SyntaxHighlighting → MinimalCallout → ClickableImages → ImageGallery → CrawlLinks → etc.)
2. **Filters** - Filter content (e.g., remove drafts)
3. **Emitters** - Generate output files (run in parallel: ImageOptimizer, ContentPage, FolderPage, etc.)

### Frontmatter System
Each content type has required fields:
- `type` - `tanke`, `oppslagsverk`, `utkast`, or `notat`
- `why` - `keep`, `remember`, `think`, `work-out`, or `share`
- `title` - Page title (optional for tanker - auto-generated if omitted)
- `published` or `date` - Publication/creation date
- Optional: `stage` (notater only), `tags`, `aliases`, `permalink`, `draft`

### Image Handling
- Images are optimized during build by `imageOptimizer.ts`
- Consecutive images (2+) are auto-wrapped in galleries by `imageGallery.ts`
- All images get lightbox functionality from `clickableImages.ts`
- Images support layout modifiers in alt text: `|wide`, `|center`, `|small`, `|full`
- Hero images: Set `heroImage`, `hero`, or `coverImage` in frontmatter

### Content Filtering & Display
- Tanker: Stream-like display (chronological, by `date` field)
- Oppslagsverk/Utkast: List display on index page (Recent Notes)
- Notater: Special section on index (Nylige notater)
- Use `excludeFromLists: true` in frontmatter to hide from index lists

## TypeScript & Build System

- Target: ESNext with Preact JSX (`jsxImportSource: "preact"`)
- Strict mode enabled
- Tests use Node's built-in test runner (`tsx --test`)
- Build uses esbuild via Quartz's custom build pipeline

## Common Commands

### Build & Development
- `npm run build` - Build the site
- `npx quartz build --serve` - Build and serve with live preview
- `npm run docs` - Build docs (alternative)
- `npm run quartz <command>` - Run Quartz CLI directly

### Testing & Code Quality
- `npm run test` - Run tests
- `npm run check` - Type checking (no output)
- `npm run format` - Format code with Prettier

### Content Creation
- `node scripts/new-post.js` - Create a new post interactively
- `./scripts/new-post-wrapper.sh` - Or use the wrapper script

## Custom Features

### Minimal Callouts
Cleaner, more subtle callout syntax:
```markdown
> [minimal-tip]
> Your tip content here
```
Types: `minimal-tip`, `minimal-note`, `minimal-warning`, `minimal-info`, `minimal-quote`, `minimal-success`, `minimal-question`

### Why Field Component
Displays the purpose of a piece in the sidebar:
- "This is to: remember"
- "This is to: think and share"

### Category List
Custom explorer showing content folders with:
- Custom folder order configuration
- Always-show folders (even if empty)
- Exclude folders capability

## Writing Patterns

### Wikilinks & Aliases
- Use `[[page-name]]` for internal links
- Use `[[page-name | Custom Text]]` for custom link text
- Use `[[page-name#Section]]` to link to specific sections
- Set `aliases` in frontmatter to enable title-based linking: `[[My Page Title]]` instead of slug
- Wikilinks use shortest path resolution - prefer `[[example]]` over full paths when unique

### Transclusion
- Embed entire pages: `![[page-name]]`
- Embed sections: `![[page-name#Section Header]]`
- Embed blocks: `![[page-name#^block-id]]`

### Image Embedding
- Basic: `![[image.jpg]]` or `![Alt text](path/to/image.jpg)`
- Layout modifiers in alt text: `![Description|wide](image.jpg)`
  - `|wide` - Full width, centered, height limited
  - `|center` - Medium width, centered
  - `|small` - Smaller floating image
  - `|full` - Maximum impact, full width
- Default images float with text (alternating left/right)
- Consecutive images (2+) automatically form galleries

## Development Workflow

1. **Add new content**: Use `node scripts/new-post.js` for guided creation
2. **Preview changes**: Run `npx quartz build --serve` to see live updates
3. **Custom components**: Add to `quartz/components/`, export in `index.ts`, register in `quartz.layout.ts`
4. **Custom plugins**: Add to `quartz/plugins/transformers|emitters|filters/`, export in `index.ts`, register in `quartz.config.ts`
5. **Styling**: Edit SCSS in `quartz/styles/` or component-specific `styles/` directories
6. **Type checking**: Run `npm run check` before committing

## Important Notes

- Treat **URLs and internal links** as a stability surface:
  - Avoid unnecessary slug/path changes.
  - Prefer `aliases` / stable `permalink` (especially for `notater`) when moving/renaming content.
  - When changing link behavior, consider the impact on historical content and cross-note references.
- Content folder names are case-sensitive in the file system but slugified to lowercase in URLs
- Wikilinks use shortest path resolution: `[[example-post]]` instead of full paths when unique
- Permalinks are recommended for notater to maintain stable URLs
- Draft posts (`draft: true`) are filtered out during build
- The `CategoryList` component uses folder index pages for titles (e.g., `Tanker/index.md`)
- Images in `public/` are served as-is; images in `content/` are optimized during build
- Always use co-author attribution when committing: `Co-Authored-By: Warp <agent@warp.dev>`

## Testing

- Run tests with: `npm run test`
- Test files are located alongside source files with `.test.ts` extension:
  - `quartz/components/scripts/search.test.ts`
  - `quartz/util/fileTrie.test.ts`
  - `quartz/util/path.test.ts`
